<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerador - Test Harness</title>
  <link rel="stylesheet" href="gerador.css">
  <style>
    body { padding: 20px; }
    .panel { background: #fff; border-radius: 8px; padding: 12px 16px; margin-bottom: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    label { display:block; margin-top:8px; font-weight:600 }
    input[type=text], select { width:100%; padding:8px; margin-top:6px; }
    button { margin-top:8px; }
    pre { background:#f6f8fa; padding:10px; border-radius:6px; overflow:auto }
  </style>
</head>
<body>
  <h1>Test Harness — Gerador</h1>
  <p>Esta página carrega <code>gerador.js</code> e oferece controles para testar as funções principais.</p>

  <div class="panel">
    <h3>1) Decodificar/Codificar códigos</h3>
    <label for="codeIn">Código (ex.: ABCDEF0123)</label>
    <input id="codeIn" type="text" placeholder="Cole aqui o código (10 chars)">
    <button id="btnDecode">Decodificar</button>
    <pre id="decodeOut">Resultado da decodificação aparecerá aqui</pre>

    <hr>
    <h4>Codificar (entradas manuais)</h4>
    <label>Género</label>
    <select id="selGenero"><option value="M">M</option><option value="F">F</option></select>
    <label>animalIdx (número)</label>
    <input id="inAnimalIdx" type="text" value="0">
    <label>adjetivoIdx</label>
    <input id="inAdjetivoIdx" type="text" value="0">
    <label>negacaoIdx</label>
    <input id="inNegacaoIdx" type="text" value="0">
    <label>verboIdx</label>
    <input id="inVerboIdx" type="text" value="0">
    <label>lugarIdx</label>
    <input id="inLugarIdx" type="text" value="0">
    <button id="btnEncode">Codificar</button>
    <pre id="encodeOut">Código gerado aparecerá aqui</pre>
  </div>

  <div class="panel">
    <h3>2) Gerar ditado</h3>
    <button id="btnGenerate">GerarDitado()</button>
    <button id="btnGenerateWithSelections">Gerar com seleções atuais</button>
    <pre id="generateOut">Resultado do gerador</pre>
    <h4>Histórico (conteúdo da variável)</h4>
    <button id="btnShowHistory">Mostrar histórico</button>
    <pre id="historyOut"></pre>
  </div>

  <div class="panel">
    <h3>3) Carregar Google Sheets</h3>
    <label for="sheetUrl">Google Sheets URL (se em branco usa DEFAULT_SHEETS_URL)</label>
    <input id="sheetUrl" type="text" placeholder="URL da planilha">
    <label><input id="chkApply" type="checkbox" checked> Aplicar ao sucesso (gerar novo ditado)</label>
    <button id="btnLoadSheet">Carregar planilha (chama carregarDoGoogleSheets)</button>
    <pre id="sheetOut">Mensagens do carregamento aparecerão aqui</pre>
    <div style="margin-top:8px">Status persistente: <span id="lastStatus"></span></div>
  </div>

  <div class="panel">
    <h3>4) Extras</h3>
    <button id="btnClearLocalHistory">Limpar histórico localStorage</button>
    <button id="btnShowVars">Mostrar variáveis principais (palavras/historico)</button>
    <pre id="varsOut"></pre>
  </div>

  <script src="gerador.js" defer></script>
  <script>
    // Wait until gerador.js loaded (defer) -- functions are global
    document.addEventListener('DOMContentLoaded', () => {
      const btnDecode = document.getElementById('btnDecode');
      const decodeOut = document.getElementById('decodeOut');
      const codeIn = document.getElementById('codeIn');
      const btnEncode = document.getElementById('btnEncode');
      const encodeOut = document.getElementById('encodeOut');

      btnDecode.addEventListener('click', () => {
        const c = codeIn.value.trim();
        try {
          const res = window.decodificarDitado ? decodificarDitado(c) : null;
          decodeOut.textContent = JSON.stringify(res, null, 2);
        } catch (e) {
          decodeOut.textContent = 'Erro: '+e.message;
        }
      });

      btnEncode.addEventListener('click', () => {
        const genero = document.getElementById('selGenero').value;
        const selecoes = {
          genero,
          animalIdx: parseInt(document.getElementById('inAnimalIdx').value || '0',10),
          adjetivoIdx: parseInt(document.getElementById('inAdjetivoIdx').value || '0',10),
          negacaoIdx: parseInt(document.getElementById('inNegacaoIdx').value || '0',10),
          verboIdx: parseInt(document.getElementById('inVerboIdx').value || '0',10),
          lugarIdx: parseInt(document.getElementById('inLugarIdx').value || '0',10)
        };
        try {
            
          const code = window.codificarDitado ? codificarDitado(selecoes) : 'codificarDitado não encontrado';
          encodeOut.textContent = code + '\n-- seleções: ' + JSON.stringify(selecoes);
        } catch (e) {
          encodeOut.textContent = 'Erro: '+e.message;
        }
      });

      // gerar
      const btnGenerate = document.getElementById('btnGenerate');
      const btnGenerateWithSelections = document.getElementById('btnGenerateWithSelections');
      const generateOut = document.getElementById('generateOut');

      btnGenerate.addEventListener('click', () => {
        try {
          const res = window.gerarDitado ? gerarDitado() : null;
          generateOut.textContent = JSON.stringify(res, null, 2);
        } catch (e) {
          generateOut.textContent = 'Erro: '+e.message;
        }
      });

      btnGenerateWithSelections.addEventListener('click', () => {
        try {
          const sel = window.selecoesAtuais || null;
          if (!sel) return generateOut.textContent = 'Nenhuma seleção atual disponível';
          const res = gerarDitado(sel);
          generateOut.textContent = JSON.stringify(res, null, 2);
        } catch (e) {
          generateOut.textContent = 'Erro: '+e.message;
        }
      });

      // history
      const btnShowHistory = document.getElementById('btnShowHistory');
      const historyOut = document.getElementById('historyOut');
      btnShowHistory.addEventListener('click', () => {
        historyOut.textContent = JSON.stringify(window.historico || [], null, 2);
      });

      // carregar sheets
      const btnLoadSheet = document.getElementById('btnLoadSheet');
      const sheetUrl = document.getElementById('sheetUrl');
      const chkApply = document.getElementById('chkApply');
      const sheetOut = document.getElementById('sheetOut');
      const lastStatus = document.getElementById('lastStatus');

      btnLoadSheet.addEventListener('click', async () => {
        const u = sheetUrl.value.trim() || DEFAULT_SHEETS_URL;
        const apply = !!chkApply.checked;
        sheetOut.textContent = 'Carregando...';
        try {
          await carregarDoGoogleSheets(u, { applyOnSuccess: apply });
          sheetOut.textContent = 'Concluído — verifique console e #lastSheetStatus na UI principal.';
        } catch (e) {
          sheetOut.textContent = 'Erro: ' + e.message;
        }
        const ls = document.getElementById('lastSheetStatus');
        lastStatus.textContent = ls ? ls.textContent : '(não disponível)';
      });

      // extras
      document.getElementById('btnClearLocalHistory').addEventListener('click', () => {
        localStorage.removeItem('ditadosHistorico');
        alert('Histórico local limpo');
      });

      document.getElementById('btnShowVars').addEventListener('click', () => {
        const out = {
          palavras: window.palavras,
          historico: window.historico
        };
        document.getElementById('varsOut').textContent = JSON.stringify(out, null, 2);
      });

      // keep lastStatus updated periodically
      setInterval(() => {
        const ls = document.getElementById('lastSheetStatus');
        if (ls) lastStatus.textContent = ls.textContent;
      }, 1000);
    });
  </script>
</body>
</html>
